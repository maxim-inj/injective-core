name: Publish NPM and PyPI Packages (Parallel)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.17.2)'
        required: true
        type: string

env:
  GO_VERSION: "1.23.9"
  NODE_VERSION: "25"
  PYTHON_VERSION: "3.12"

jobs:
  # =============================================================================
  # Build binaries (matrix)
  # =============================================================================
  build-binaries:
    name: Build Binary (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: darwin-arm64
            os: macos-latest
            goos: darwin
            goarch: arm64
            wasmvm_lib: libwasmvm.dylib
          - name: linux-arm64
            os: ubuntu-22.04-arm
            goarch: arm64
            goos: linux
            wasmvm_lib: libwasmvm.aarch64.so
          - name: linux-x64
            os: ubuntu-22.04
            goos: linux
            goarch: amd64
            wasmvm_lib: libwasmvm.x86_64.so

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        run: |
          if make -n release-binary-${{ matrix.platform.name }} >/dev/null 2>&1; then
            make release-binary-${{ matrix.platform.name }}
            exit 0
          fi

          echo "release-binary-${{ matrix.platform.name }} target not found, falling back to install-ci"
          mkdir -p packaging/binaries
          tmp_dir="packaging/binaries/tmp-${{ matrix.platform.name }}"
          rm -rf "${tmp_dir}"
          mkdir -p "${tmp_dir}"
          GOBIN="$(pwd)/${tmp_dir}" GOOS="${{ matrix.platform.goos }}" GOARCH="${{ matrix.platform.goarch }}" CGO_ENABLED=1 make install-ci
          cp "${tmp_dir}/injectived" "packaging/binaries/injectived-${{ matrix.platform.name }}"
          chmod +x "packaging/binaries/injectived-${{ matrix.platform.name }}"
          wasmvm_dir=$(go list -m -f '{{.Dir}}' github.com/CosmWasm/wasmvm/v2)
          cp "${wasmvm_dir}/internal/api/${{ matrix.platform.wasmvm_lib }}" "packaging/binaries/${{ matrix.platform.wasmvm_lib }}"
          rm -rf "${tmp_dir}"

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.platform.name }}
          path: |
            packaging/binaries/injectived-${{ matrix.platform.name }}
            packaging/binaries/${{ matrix.platform.wasmvm_lib }}
          retention-days: 1

  # =============================================================================
  # Build NPM packages (parallel per platform)
  # =============================================================================
  build-npm-platform:
    name: Build NPM ${{ matrix.platform }}
    needs: build-binaries
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        platform: [darwin-arm64, linux-arm64, linux-x64]
        include:
          - platform: darwin-arm64
            node_os: darwin
            node_arch: arm64
          - platform: linux-arm64
            node_os: linux
            node_arch: arm64
          - platform: linux-x64
            node_os: linux
            node_arch: x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.platform }}
          path: packaging/binaries

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build NPM package
        working-directory: packaging
        run: |
          VERSION_NO_V="${{ github.event.inputs.tag }}"
          VERSION_NO_V="${VERSION_NO_V#v}"
          
          docker buildx build \
            --file Dockerfile \
            --target npm-output \
            --output type=local,dest=./output \
            --build-arg PLATFORM="${{ matrix.platform }}" \
            --build-arg NODE_OS="${{ matrix.node_os }}" \
            --build-arg NODE_ARCH="${{ matrix.node_arch }}" \
            --build-arg NODE_VERSION="$VERSION_NO_V" \
            .
          
          ls -la output/npm/

      - name: Upload NPM package
        uses: actions/upload-artifact@v4
        with:
          name: npm-${{ matrix.platform }}
          path: packaging/output/npm/injective-core-${{ matrix.platform }}
          retention-days: 1

  # =============================================================================
  # Build base NPM package (once)
  # =============================================================================
  build-npm-base:
    name: Build NPM Base Package
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build base package
        working-directory: packaging
        run: |
          VERSION_NO_V="${{ github.event.inputs.tag }}"
          VERSION_NO_V="${VERSION_NO_V#v}"
          
          # Build base package only (using npm-builder stage but extract just the package)
          docker buildx build \
            --file Dockerfile \
            --target npm-builder \
            --output type=local,dest=./output/build \
            --build-arg VERSION="$VERSION_NO_V" \
            .
          
          # Extract the compiled package
          mkdir -p output/npm/injective-core
          cp -r output/build/build/npm/injective-core/* output/npm/injective-core/ || \
            cp -r output/build/npm/injective-core/* output/npm/injective-core/
          
          ls -la output/npm/injective-core/

      - name: Upload base package
        uses: actions/upload-artifact@v4
        with:
          name: npm-base
          path: packaging/output/npm/injective-core
          retention-days: 1

  # =============================================================================
  # Build PyPI packages (parallel per platform)
  # =============================================================================
  build-pypi-platform:
    name: Build PyPI ${{ matrix.platform }}
    needs: build-binaries
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        platform: [darwin-arm64, linux-arm64, linux-x64]
        include:
          - platform: darwin-arm64
            pypi_platform: macosx_11_0_arm64
          - platform: linux-arm64
            pypi_platform: manylinux_2_17_aarch64
          - platform: linux-x64
            pypi_platform: manylinux_2_17_x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.platform }}
          path: packaging/binaries

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build PyPI wheel
        working-directory: packaging
        run: |
          VERSION_NO_V="${{ github.event.inputs.tag }}"
          VERSION_NO_V="${VERSION_NO_V#v}"
          
          docker buildx build \
            --file Dockerfile \
            --target pypi-output \
            --output type=local,dest=./output \
            --build-arg PLATFORM="${{ matrix.platform }}" \
            --build-arg PYPI_PLATFORM="${{ matrix.pypi_platform }}" \
            --build-arg VERSION="$VERSION_NO_V" \
            .
          
          ls -la output/pypi/

      - name: Upload PyPI wheel
        uses: actions/upload-artifact@v4
        with:
          name: pypi-${{ matrix.platform }}
          path: packaging/output/pypi/*.whl
          retention-days: 1
          if-no-files-found: error

  # =============================================================================
  # Collect and publish NPM
  # =============================================================================
  publish-npm:
    name: Publish NPM
    needs: [build-npm-base, build-npm-platform]
    runs-on: ubuntu-22.04
    environment: npm
    steps:
      - name: Download all NPM packages
        uses: actions/download-artifact@v4
        with:
          path: npm-packages
          pattern: npm-*

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Organize packages
        run: |
          rm -rf output/npm
          mkdir -p output/npm/injective-core
          if [ ! -d "npm-packages/npm-base" ]; then
            echo "Error: npm-base artifact not found"
            exit 1
          fi
          base_dir="npm-packages/npm-base"
          if [ -d "npm-packages/npm-base/injective-core" ]; then
            base_dir="npm-packages/npm-base/injective-core"
          fi
          if [ -z "$(ls -A "$base_dir" 2>/dev/null)" ]; then
            echo "Error: npm-base artifact is empty at $base_dir"
            ls -la npm-packages/npm-base || true
            exit 1
          fi
          rsync -a "$base_dir"/ output/npm/injective-core/
          for dir in npm-packages/npm-*; do
            if [ -d "$dir" ]; then
              artifact="$(basename "$dir")"
              if [ "$artifact" = "npm-base" ]; then
                continue
              fi
              platform="${artifact#npm-}"
              dest="output/npm/injective-core-${platform}"
              mkdir -p "$dest"
              rsync -a "$dir"/ "$dest"/
            fi
          done
          ls -la output/npm/
          if ! ls output/npm/injective-core-* >/dev/null 2>&1; then
            echo "Error: no platform-specific NPM packages found"
            find npm-packages -maxdepth 2 -type d -print
            exit 1
          fi

      - name: Publish NPM packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          shopt -s nullglob

          total=0
          published=0
          skipped=0

          publish_pkg() {
            local dir="$1"
            if [ ! -d "$dir" ]; then
              return
            fi
            if [ ! -f "$dir/package.json" ]; then
              echo "Skipping $dir (missing package.json)"
              return
            fi
            total=$((total + 1))
            pushd "$dir" >/dev/null
            local name version
            name="$(node -p "require('./package.json').name")"
            version="$(node -p "require('./package.json').version")"
            if npm view "${name}@${version}" >/dev/null 2>&1; then
              echo "Skipping ${name}@${version} (already published)"
              skipped=$((skipped + 1))
            else
              echo "Publishing ${name}@${version}"
              npm publish --access public
              published=$((published + 1))
            fi
            popd >/dev/null
          }

          platform_dirs=(output/npm/injective-core-*)
          if [ ${#platform_dirs[@]} -eq 0 ]; then
            echo "Error: no platform-specific NPM packages found to publish"
            exit 1
          fi

          for dir in "${platform_dirs[@]}"; do
            publish_pkg "$dir"
          done

          # Publish base package last (optionalDependencies point at platform packages)
          publish_pkg "output/npm/injective-core"

          if [ "$total" -eq 0 ]; then
            echo "Error: no NPM packages found to publish"
            exit 1
          fi

          if [ "$published" -eq 0 ] && [ "$skipped" -eq "$total" ]; then
            echo "Error: all NPM packages were skipped (already published)"
            exit 1
          fi

  # =============================================================================
  # Collect and publish PyPI
  # =============================================================================
  publish-pypi:
    name: Publish PyPI
    needs: build-pypi-platform
    runs-on: ubuntu-22.04
    environment: pypi
    steps:
      - name: Download all PyPI wheels
        uses: actions/download-artifact@v4
        with:
          path: pypi-packages
          pattern: pypi-*

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install twine
        run: pip install twine

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          mkdir -p dist
          for dir in pypi-packages/pypi-*; do
            if [ -d "$dir" ]; then
              cp "$dir"/* dist/
            fi
          done
          ls -la dist/
          twine upload dist/*
