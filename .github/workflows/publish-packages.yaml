name: Publish NPM and PyPI Packages (Parallel)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.17.2)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (do not actually publish)'
        required: false
        default: false
        type: boolean

env:
  GO_VERSION: "1.23.9"
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.12"

jobs:
  # =============================================================================
  # Build binaries (matrix)
  # =============================================================================
  build-binaries:
    name: Build Binary (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: darwin-arm64
            os: macos-latest
            goos: darwin
            goarch: arm64
            wasmvm_lib: libwasmvm.dylib
          - name: linux-arm64
            os: ubuntu-22.04-arm
            goarch: arm64
            goos: linux
            wasmvm_lib: libwasmvm.aarch64.so
          - name: linux-x64
            os: ubuntu-22.04
            goos: linux
            goarch: amd64
            wasmvm_lib: libwasmvm.x86_64.so

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        run: |
          if make -n release-binary-${{ matrix.platform.name }} >/dev/null 2>&1; then
            make release-binary-${{ matrix.platform.name }}
            exit 0
          fi

          echo "release-binary-${{ matrix.platform.name }} target not found, falling back to install-ci"
          mkdir -p packaging/binaries
          tmp_dir="packaging/binaries/tmp-${{ matrix.platform.name }}"
          rm -rf "${tmp_dir}"
          mkdir -p "${tmp_dir}"
          GOBIN="$(pwd)/${tmp_dir}" GOOS="${{ matrix.platform.goos }}" GOARCH="${{ matrix.platform.goarch }}" CGO_ENABLED=1 make install-ci
          cp "${tmp_dir}/injectived" "packaging/binaries/injectived-${{ matrix.platform.name }}"
          chmod +x "packaging/binaries/injectived-${{ matrix.platform.name }}"
          wasmvm_dir=$(go list -m -f '{{.Dir}}' github.com/CosmWasm/wasmvm/v2)
          cp "${wasmvm_dir}/internal/api/${{ matrix.platform.wasmvm_lib }}" "packaging/binaries/${{ matrix.platform.wasmvm_lib }}"
          rm -rf "${tmp_dir}"

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.platform.name }}
          path: |
            packaging/binaries/injectived-${{ matrix.platform.name }}
            packaging/binaries/${{ matrix.platform.wasmvm_lib }}
          retention-days: 1

  # =============================================================================
  # Build NPM packages (parallel per platform)
  # =============================================================================
  build-npm-platform:
    name: Build NPM ${{ matrix.platform }}
    needs: build-binaries
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        platform: [darwin-arm64, linux-arm64, linux-x64]
        include:
          - platform: darwin-arm64
            node_os: darwin
            node_arch: arm64
          - platform: linux-arm64
            node_os: linux
            node_arch: arm64
          - platform: linux-x64
            node_os: linux
            node_arch: x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.platform }}
          path: packaging/binaries

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build NPM package
        working-directory: packaging
        run: |
          VERSION_NO_V="${{ github.event.inputs.tag }}"
          VERSION_NO_V="${VERSION_NO_V#v}"
          
          docker buildx build \
            --file Dockerfile \
            --target npm-output \
            --output type=local,dest=./output \
            --build-arg PLATFORM="${{ matrix.platform }}" \
            --build-arg NODE_OS="${{ matrix.node_os }}" \
            --build-arg NODE_ARCH="${{ matrix.node_arch }}" \
            --build-arg NODE_VERSION="$VERSION_NO_V" \
            .
          
          ls -la output/npm/

      - name: Upload NPM package
        uses: actions/upload-artifact@v4
        with:
          name: npm-${{ matrix.platform }}
          path: packaging/output/npm/injective-cli-${{ matrix.platform }}
          retention-days: 1

  # =============================================================================
  # Build base NPM package (once)
  # =============================================================================
  build-npm-base:
    name: Build NPM Base Package
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build base package
        working-directory: packaging
        run: |
          VERSION_NO_V="${{ github.event.inputs.tag }}"
          VERSION_NO_V="${VERSION_NO_V#v}"
          
          # Build base package only (using npm-builder stage but extract just the package)
          docker buildx build \
            --file Dockerfile \
            --target npm-builder \
            --output type=local,dest=./output/build \
            --build-arg VERSION="$VERSION_NO_V" \
            .
          
          # Extract the compiled package
          mkdir -p output/npm/injective-cli
          cp -r output/build/build/npm/injective-core/* output/npm/injective-cli/ || \
            cp -r output/build/npm/injective-core/* output/npm/injective-cli/
          
          ls -la output/npm/injective-cli/

      - name: Upload base package
        uses: actions/upload-artifact@v4
        with:
          name: npm-base
          path: packaging/output/npm/injective-cli
          retention-days: 1

  # =============================================================================
  # Build PyPI packages (parallel per platform)
  # =============================================================================
  build-pypi-platform:
    name: Build PyPI ${{ matrix.platform }}
    needs: build-binaries
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        platform: [darwin-arm64, linux-arm64, linux-x64]
        include:
          - platform: darwin-arm64
            pypi_platform: macosx_11_0_arm64
          - platform: linux-arm64
            pypi_platform: linux_arm64
          - platform: linux-x64
            pypi_platform: linux_x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.platform }}
          path: packaging/binaries

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build PyPI wheel
        working-directory: packaging
        run: |
          VERSION_NO_V="${{ github.event.inputs.tag }}"
          VERSION_NO_V="${VERSION_NO_V#v}"
          
          docker buildx build \
            --file Dockerfile \
            --target pypi-output \
            --output type=local,dest=./output \
            --build-arg PLATFORM="${{ matrix.platform }}" \
            --build-arg PYPI_PLATFORM="${{ matrix.pypi_platform }}" \
            --build-arg VERSION="$VERSION_NO_V" \
            .
          
          ls -la output/pypi/

      - name: Upload PyPI wheel
        uses: actions/upload-artifact@v4
        with:
          name: pypi-${{ matrix.platform }}
          path: packaging/output/pypi/*.whl
          retention-days: 1
          if-no-files-found: error

  # =============================================================================
  # Collect and publish NPM
  # =============================================================================
  publish-npm:
    name: Publish NPM
    needs: [build-npm-base, build-npm-platform]
    runs-on: ubuntu-22.04
    environment: npm
    if: ${{ !github.event.inputs.dry_run }}
    steps:
      - name: Download all NPM packages
        uses: actions/download-artifact@v4
        with:
          path: npm-packages
          pattern: npm-*

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Organize packages
        run: |
          mkdir -p output/npm
          mv npm-packages/npm-base/* output/npm/injective-cli/
          for dir in npm-packages/npm-*; do
            if [ -d "$dir" ]; then
              mv "$dir"/* output/npm/
            fi
          done
          ls -la output/npm/

      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for dir in output/npm/injective-cli-*; do
            if [ -d "$dir" ]; then
              echo "Publishing $(basename $dir)..."
              cd "$dir"
              npm publish --access public
              cd -
            fi
          done

      - name: Publish base package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          sleep 10
          cd output/npm/injective-cli
          npm publish --access public

  # =============================================================================
  # Collect and publish PyPI
  # =============================================================================
  publish-pypi:
    name: Publish PyPI
    needs: build-pypi-platform
    runs-on: ubuntu-22.04
    environment: pypi
    if: ${{ !github.event.inputs.dry_run }}
    steps:
      - name: Download all PyPI wheels
        uses: actions/download-artifact@v4
        with:
          path: pypi-packages
          pattern: pypi-*

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install twine
        run: pip install twine

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          mkdir -p dist
          for dir in pypi-packages/pypi-*; do
            if [ -d "$dir" ]; then
              cp "$dir"/* dist/
            fi
          done
          ls -la dist/
          twine upload dist/*
